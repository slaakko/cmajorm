<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Setting up Cmajor compiler development environment</title>
    <link href="style.css" rel="stylesheet" type="text/css" />
</head>
<body>
    <h1>Setting up Cmajor compiler development environment</h1>

	<p>
		This document contains instructions how to build the Cmajor compiler, tools and libraries from sources.
	</p>

	<h2>
		Requirements
	</h2>
	
	<ul>
		<li>Microsoft Visual Studio Community Edition 2019</li>
	</ul>

    <h2>
        1. Boost (C++ msvc)
    </h2>
    
    <h3>
        Version
    </h3>
    
    <p>
        <strong>1.74</strong>
    </p>
    
    <h3>
        Default location:
    </h3>
    
    <p>
        <strong>C:\boost</strong>
    </p>
    
    <h3>
        Sources
    </h3>
    
    <p>
        <a href="https://boost.org">boost.org</a>
    </p>
    
    <p>
        Extract sources to <strong>C:\work\boost_1_74_0</strong> directory.
		(For example place boost_1_74_0.7z package in C:\work directory and choose 7-Zip | Extract here)
    </p>
    
    <h3>
        Build
    </h3>
    
    <ol>
    
    <li>Open x64 Native Tools Command Prompt for VS 2019 (can be found from the start menu in Visual Studio 2019 folder)</li>
    
    <li>Change to C:\work\boost_1_74_0 directory.</li>
    
    <li>
        Bootstrap:
    <pre>
        C:\work\boost_1_74_0> bootstrap
    </pre>
    </li>
    
    <li>
        Compilation:
    <pre>
        C:\work\boost_1_74_0> b2 toolset=msvc address-model=64 --build-dir=C:\boost-build-dir --prefix=C:\boost install
    </pre>
    </li>
	
    <li>
        After compiling <strong>C:\boost-build-dir</strong> ja <strong>C:\work\boost_1_74_0</strong> can be removed.
    </li>
    
	</ol>
    
    <h2>
        2. Mingw-w64
    </h2>

    <h3>
        Download
    </h3>

    <p>
        From the <a href="http://mingw-w64.org/doku.php/download">Download</a> page select MingW-W64-builds.
    </p>

    <h3>
        Version
    <h3>
    
    <p>
        <strong>8.1.0</strong>
    </p>
    
    <h3>
        Installation
    </h3>
    
    <ol>
    
    <li>
    <p>
        Installation using these settings:<br/>
        <img src="mingw.png"/>
    </p>
    </li>

    <li>
        Add <strong>C:\Program Files\mingw-w64\x86_64-8.1.0-posix-seh-rt_v6-rev0\mingw64\bin</strong> directory to PATH.
    </li>

    </ol>
    
    <h2>
        3. Boost (C++ mingw-w64)
    </h2>
    
    <h3>
        Version
    </h3>
    
    <p>
        <strong>1.74</strong>
    </p>
    
    <h3>
        Default location:
    </h3>
    
    <p>
        <strong>C:\mingw-boost</strong>
    </p>
    
    <h3>
        Sources
    </h3>
    
    <p>
        <a href="https://boost.org">boost.org</a>
    </p>
    
    <p>
         Extract sources to <strong>C:\work\boost_1_74_0</strong> directory.
    </p>
    
    <h3>
        Build
    </h3>

    <ol>
    
    <li>Open Windows Terminal (wt.exe) to <strong>C:\work\boost_1_74_0</strong> directory:
    
    <li>
        It's assumed that mingw-w64's gcc can be found from PATH: gcc --version
    </li>
    
    <li>
        Bootstrap:
        
    <pre>
        C:\work\boost_1_74_0> bootstrap gcc
    </pre>
        
    </li>
    
    <li>
        Compilation:
    <pre>
        C:\work\boost_1_74_0> b2 toolset=gcc address-model=64 --build-dir=C:\mingw-boost-build-dir --prefix=C:\mingw-boost install
    </pre>
    </li>
    
    <li>
        After compiling <strong>C:\mingw-boost-build-dir</strong> ja <strong>C:\work\boost_1_74_0</strong> can be removed.
    </li>
    
    </ol>
    
    <h2>
        4. LLVM binaries
    </h2>
    
    <h3>
        Version
    </h3>
    
    <p>
        <strong>11.0.0</strong>
    </p>
    
    <h3>
        Default location:
    </h3>
    
    <p>
        <strong>C:\Program Files\LLVM</strong>
    </p>
    
    <h3>
        Download
    </h3>
    
    <p>
        From the <a href="https://releases.llvm.org/download.html#11.0.0">Download</a> page select Windows (64-bit) link.
    </p>
    
    <p>
        This is a direct link: <a href="https://github.com/llvm/llvm-project/releases/download/llvmorg-11.0.0/LLVM-11.0.0-win64.exe">LLVM-11.0.0-win64.exe</a>
    </p>
    
    <h3>
        Installation
    </h3>
    
    <ol>
        <li>After installation add <strong>C:\Program Files\LLVM\bin</strong> directory to PATH.
    </ol>
    
    <h2>
        5. CMake
    </h2>
    
    <h3>
        Version
    </h3>
    
    <p>
        <strong>3.18.4</strong>
    </p>
    
    <h3>
        Default location:
    </h3>
    
    <p>
        <strong>C:\Program Files\CMake</strong>
    </p>
    
    <h3>
        Download
    </h3>
    
    <p>
        From the <a href="https://cmake.org/download/">Download</a> page select cmake-3.18.4-win64-x64.msi link.
    </p>
    
    <p>
        This is a direct link: <a href="https://github.com/Kitware/CMake/releases/download/v3.18.4/cmake-3.18.4-win64-x64.msi">cmake-3.18.4-win64-x64.msi</a>
    </p>
    
    <h3>
        Installation
    </h3>
    
    <ol>
    
    <li>
    <p>
        Installation using these settings:<br/>
        <img src="cmake.png"/>
    </p>
    </li>

    </ol>
    
	<h2>
		6. Python
	</h2>
	
	<h3>
		Version
	</h3>
	
	<p>
		3.9.0
	</p>
	
	<h3>
		Default location
	</h3>
	
	<p>
		C:\Program Files\Python39
	</p>
	
	<h3>
		Download
	</h3>
	
	<p>
		From the <a href="https://www.python.org/downloads/">Download</a> page select Download Python 3.9.0.
	</p>
	
	<h3>
		Installation
	</h3>
	
	<p>
		Installation using these settings:<br/>
		<br/>
		<img src="python.png"/>
	</p>
	
	<h2>
		7. LLVM sources
    </h2>
    
    <h3>
        Version
    </h3>
    
    <p>
        <strong>11.0.0</strong>
    </p>
    
    <h3>
        Default location:
    </h3>
    
    <p>
        <strong>C:\llvm-11.0.0.src</strong>
    </p>
    
    <h3>
        Download
    </h3>
    
    <p>
        From the <a href="https://releases.llvm.org/download.html#11.0.0">Download</a> page select LLVM source code.
    </p>
    
    <p>
        This is a direct link: <a href="https://github.com/llvm/llvm-project/releases/download/llvmorg-11.0.0/llvm-11.0.0.src.tar.xz">llvm-11.0.0.src.tar.xz</a>
    </p>
    
    <p>
        Extract package to <strong>C:\llvm-11.0.0.src</strong> folder.
    </p>
    
    <h3>
        Compilation
    </h3>
    
    <ol>
        <li>
            Open x64 Native Tools Command Prompt for VS 2019.
        </li>
        
        <li>
            Change to C:\llvm-11.0.0.src directory.
        </li>
        
        <li>
            Make directory <strong>build</strong>:
            
        <pre>
            C:\llvm-11.0.0.src>mkdir build
        </pre>
        </li>
        
        <li>
            Change to <strong>build</strong> directory:
            
        <pre>
            C:\llvm-11.0.0.src>cd build
        </pre>
        </li>
        
        <li>
            Run CMake:
            
        <pre>
            C:\llvm-11.0.0.src\build> cmake -G "Visual Studio 16 2019" -Thost=x64 -DLLVM_TARGETS_TO_BUILD="X86" -DLLVM_ENABLE_EH=On -DLLVM_ENABLE_RTTI=On ..
        </pre>
        </li>
        
        <li>
            Open <strong>C:\llvm-11.0.0.src\build\LLVM.sln</strong> solution in Visual Studio 2019.
        </li>
        
        <li>
            Build solution using Debug/x64 configuration.
        </li>

        <li>
            Build solution using Release/x64 configuration
        </li>
    </ol>
	
	<h2>
		8. Git for Windows
	</h2>
	
	<h3>
		Versio
	</h3>
	
	<p><strong>2.28.0</strong></p>
    
	<h3>
		Download
	</h3>
	
	<p><a href="https://git-scm.com/download/win">Git for Windows</a></p>.
	
	<h2>
        9. Cmajor compiler and C++ runtime
    </h2>
    
    <h3>
        Default location
    </h3>
    
    <p>
        <strong>C:\work\cmajorm</strong>
    </p>
    
    <h3>
        Download
    </h3>
    
    From <a href="https://github.com/slaakko/cmajorm">https://github.com/slaakko/cmajorm</a> page select Code | https://github.com/slaakko/cmajorm.git
    
    <ol>
    <li>
		Start Git Bash.
    </li>
    <li>
		Change to C:\work directory.
	</li>
	<li>
		Clone cmajorm repository:
	<pre>
		git clone https://github.com/slaakko/cmajorm.git
	</pre>
	</li>
	<li>
		Clones repository to cmajorm directory.
	</li>
    </ol>
	
	<h3>
		Configuration
	</h3>
	
	<h4>
		MS Visual C++ configuration
	</h4>
	
	<p>
		Open the <strong>C:\work\cmajorm\cmajor\config\build.props</strong> file with a text editor and set the value of the following Visual Studio user macros:
	</p>

	<ol>
		<li><strong>BOOST_INCLUDE_DIR</strong>. The default value is <strong>C:\boost\include\boost-1_74</strong>.</li>
		<li><strong>BOOST_LIB_DIR</strong>. The default value is <strong>C:\boost\lib</strong>.</li>
		<li><strong>LLVM_SRC_INCLUDE_DIR</strong>. The default value is <strong>C:\llvm-11.0.0.src\include</strong>.</li>
		<li><strong>LLVM_BUILD_INCLUDE_DIR</strong>. The default value is <strong>C:\llvm-11.0.0.src\build\include</strong>.</li>
		<li><strong>LLVM_RELEASE_LIB_DIR</strong>. The default value is <strong>C:\llvm-11.0.0.src\build\Release\lib</strong>.</li>
		<li><strong>LLVM_DEBUG_LIB_DIR</strong>. The default value is <strong>C:\llvm-11.0.0.src\build\Debug\lib</strong>.</li>
	</ol>

	<h4>
		Mingw-w64 configuration
	</h4>
	
	<p>
		Open the <strong>C:\work\cmajorm\cmajor\rts\build\gcc\Makefile.common</strong> file with a text editor and set the following paths:
	</p>
	
	<ol>
		<li><strong>BOOST_INCLUDE_DIR</strong>.	The default value is <strong>C:/mingw-boost/include/boost-1_74</strong>.</li>
		<li><strong>BOOST_LIB_DIR</strong>.	The default value is <strong>C:/mingw-boost/lib</strong>.</li>
		<li><strong>BOOST_DEBUG_FILESYSTEM_LIB</strong>. The default value is <strong>boost_filesystem-mgw8-mt-d-x64-1_74</strong>.</li>
		<li><strong>BOOST_DEBUG_IOSTREAMS_LIB</strong>. The default value is <strong>boost_iostreams-mgw8-mt-d-x64-1_74</strong>.</li>
		<li><strong>BOOST_DEBUG_SYSTEM_LIB</strong>. The default value is <strong>boost_system-mgw8-mt-d-x64-1_74</strong>.</li>
		<li><strong>BOOST_RELEASE_FILESYSTEM_LIB</strong>. The default value is <strong>boost_filesystem-mgw8-mt-x64-1_74</strong>.</li>
		<li><strong>BOOST_RELEASE_IOSTREAMS_LIB</strong>. The default value is <strong>boost_iostreams-mgw8-mt-x64-1_74</strong>.</li>
		<li><strong>BOOST_RELEASE_SYSTEM_LIB</strong>. The default value is <strong>boost_system-mgw8-mt-x64-1_74</strong>.</li>
	</ol>

	<h4>
		Static Boost library gcc tool chain configuration
	</h4>
	
	<p>
		Optional.
	</p>
	
	<p>
		Open the <strong>C:\work\cmajorm\cmajor\config\tool-chains.json</strong> file with a text editor and set Boost library version numbers in the following 
		lines:
	</p>
	
	<ol>
		<li><strong>line 302</strong>. The default libraries are <strong>boost_filesystem-mgw8-mt-d-x64-1_74</strong>,
		<strong>boost_iostreams-mgw8-mt-d-x64-1_74</strong> and <strong>boost_system-mgw8-mt-d-x64-1_74</strong>.</li>
		<li><strong>line 323</strong>. The default libraries are <strong>boost_filesystem-mgw8-mt-x64-1_74</strong>,
		<strong>boost_iostreams-mgw8-mt-x64-1_74</strong> and <strong>boost_system-mgw8-mt-x64-1_74</strong>.
	</ol>

    <h3>
        Compilation
    </h3>
    
	<p>
		There's a makefile that builds the system using nmake (Option 1), but it may not always succeed due to file sharing issues (bugs in the compiler).
		If the nmake does not succeed (after a couple of retries), it's possible to build the system the elaborate way (Option 2 and 10. onward) in stages.
	</p>
	
	<h4>
		Option 1: with makefile
	</h4>

	<ol>
        <li>Add environment variable CMAJOR_ROOT with value <strong>C:\work\cmajorm\cmajor</strong>.</li>
		<li>Create directory <strong>C:\work\cmajorm\cmajor\bin</strong>.</li>
		<li>Add <strong>C:\work\cmajorm\cmajor\bin</strong> directory to PATH.
		<li>Open x64 Native Tools Command Prompt for VS 2019</li>
		<li>Change to <strong>C:\work\cmajorm\cmajor\bat</strong> directory</li>
		<li>Run <strong>nmake</strong>
	</ol>
	
	<h4>
		Option 2: elaborate way
	</h4>
	
    <ol>
        <li>Add environment variable CMAJOR_ROOT with value <strong>C:\work\cmajorm\cmajor</strong>.</li>
		<li>Make subdirectory <strong>C:\work\cmajorm\cmajor\lib</strong></li>
        <li>Make subdirectory <strong>C:\work\cmajorm\cmajor\lib\gcc</strong></li>
        <li>Make subdirectory <strong>C:\work\cmajorm\cmajor\lib\vs</strong></li>
        <li>Make subdirectory <strong>C:\work\cmajorm\cmajor\bin</strong></li>
        <li>Make subdirectory <strong>C:\work\cmajorm\cmajor\rts\build\gcc\lib</strong></li>
        <li>Make subdirectory <strong>C:\work\cmajorm\cmajor\rts\build\gcc\bin</strong></li>		
		<li>Add <strong>C:\work\cmajorm\cmajor\bin</strong> directory to PATH.
        <li>Open x64 Native Tools Command Prompt for VS 2019</li>
        <li>Change to <strong>C:\work\cmajorm\cmajor\system\ext\pdcurs36\build</strong> directory.</li>
        <li>Run <strong>build.bat</strong>.</li>
        <li>Change to <strong>C:\work\cmajorm\cmajor\system\ext\zlib-1.2.11\contrib\masmx64</strong> directory</li>
        <li>Run <strong>bld_ml64.bat</strong></li>
        <li>Open <strong>C:\work\cmajorm\cmajor\cmajor.sln</strong> in Visual Studio 2019.</li>
        <li>Select <strong>Debug/x64</strong> configuration.</li>
        <li>Build solution.</li>
        <li>Select <strong>Release/x64</strong> configuration.</li>
        <li>Build solution.</li>
        <li>Open Windows Terminal to <strong>C:\work\cmajorm\cmajor\bat</strong> directory.</li>
        <li>Run <strong>inst.bat</strong>. Does not find all the files, but does not matter for now.</li>
        <li>Open Windows Terminal to <strong>C:\work\cmajorm\cmajor\rts\build\gcc</strong> directory.</li>
        <li>Run mingw32-make (assumed that can be found from PATH):
        <pre>
            C:\work\cmajorm\cmajor\rts\build\gcc> mingw32-make
        </pre>
        </li>
        <li>Run mingw32-make install:
        <pre>
            C:\work\cmajorm\cmajor\rts\build\gcc> mingw32-make install
        </pre>
        </li>
    </ol>

    <h2>
        10. Unicode
    </h2>

	<p>
		Not required if 9. Option 1 succeeded.
	</p>

    <h3>
        Download
    </h3>
    
    <p>
        Download <a href="https://www.unicode.org/Public/12.1.0/ucdxml/ucd.all.flat.zip">Unicode 12.1 Character Database: ucd.all.flat.zip</a> 
		and extract it to <strong>C:\work\cmajorm\cmajor\unicode</strong> directory.
    </p>
    
    <h3>
        Installation
    </h3>
    
    <ol>
        <li>Open Windows Terminal to <strong>C:\work\cmajorm\cmajor\unicode</strong> directory.</li>
        <li>Run makecmajorucd. Makes cmajor_ucd.bin Unicode database for Cmajor:
        <pre>
            C:\work\cmajorm\cmajor\unicode> makecmajorucd
        </pre>
        </li>
    </ol>

    <h2>
        11. Cmajor system libraries
    </h2>

	<p>
		Not required if 9. Option 1 succeeded.
	</p>
	
    <h3>
        Installation
    </h3>
    
    <ol>
        <li>Open Windows Terminal to <strong>C:\work\cmajorm\cmajor\system\platform\windows</strong> directory.</li>
        <li>Build System library using the debug configuration (LLVM):
        <pre>
            C:\work\cmajorm\cmajor\system\platform\windows> cmc -u -v System.cms
        </pre>
		</li>
        <li>Build System library using the release configuration (LLVM):
        <pre>
            C:\work\cmajorm\cmajor\system\platform\windows> cmc -u -v -c=release System.cms
        </pre>
		</li>
        <li>Build System library using the debug configuration (C++):
        <pre>
            C:\work\cmajorm\cmajor\system\platform\windows> cppcmc -st -u -v System.cms
        </pre>
		</li>
        <li>Build System library using the releaseconfiguration (C++):
        <pre>
            C:\work\cmajorm\cmajor\system\platform\windows> cppcmc -st -u -v -c=release System.cms
        </pre>
		</li>
    </ol>
	
	<h2>
		12. Cmajor Visual Studio extension
	</h2>
	
	<p>
		Optional.
	</p>
	
	<ol>
		<li>Open <strong>C:\work\cmajorm\cmajor\task\task.sln</strong> in Visual Studio 2019</li>
		<li>Select Debug|Any CPU -konfiguraaatio</li>
		<li>Build solution</li>
		<li>Select Release|Any CPU -konfiguraaatio</li>
		<li>Build solution</li>
		<li>Open Windows Terminal to <strong>C:\work\cmajorm\cmajor\bat</strong> directory.
		<li>Run <strong>install_vstask.bat</strong>: copies C:\work\cmajorm\cmajor\task\bin\Release\CmajorTasks.dll to bin directory.
		<li>Change to <strong>C:\work\cmajorm\cmajor\vs\2019</strong> directory.
		<li>Run CreateCmajorCPS.exe:
		<pre>
			C:\work\cmajorm\cmajor\vs\2019>CreateCmajorCPS
		</pre>
		<li>Close Windows Terminal</li>
		<li>Right click <strong>C:\work\cmajorm\cmajor\vs\2019\cmajor.vsix</strong> and select install.
	</ol>
	
	<h2>
		13. Cmajor tools
	</h2>

	<p>
		Optional and not required if 9. Option 1 succeeded.
	</p>
	
	<ol>
		<li>Open Windows Terminal to <strong>C:\work\cmajorm\cmajor\projects\cm</strong> directory.</li>
		<li>Compile Cm.cms solution using debug config:
		<pre>
			C:\work\cmajorm\cmajor\projects\cm>cmc -u -v Cm.cms
		</pre>
		</li>
		<li>Compile Cm.cms solution using release config:
		<pre>
			C:\work\cmajorm\cmajor\projects\cm>cmc -u -v -c=release Cm.cms
		</pre>
		</li>
		<li>Change to <strong>C:\work\cmajorm\cmajor\projects\tools\soulcm\scmlg</strong> directory.</li>
		<li>Compile scmlg.cmp project using debug config:
		<pre>cmc -u -v scmlg.cmp</pre>
		</li>
		<li>Compile scmlg.cmp project using release config:
		<pre>cmc -u -v -c=release scmlg.cmp</pre>
		</li>
		<li>Change to <strong>C:\work\cmajorm\cmajor\projects\tools\soulcm\scmpg</strong> directory.</li>
		<li>Compile scmpg.cmp project using debug config:
		<pre>cmc -u -v scmpg.cmp</pre>
		</li>
		<li>Compile scmpg.cmp project using release config:
		<pre>cmc -u -v -c=release scmpg.cmp</pre>
		</li>
		<li>Change to <strong>C:\work\cmajorm\cmajor\projects\tools\soulcm\scm2html</strong> directory.</li>
		<li>Compile scm2html.cmp project using debug config:
		<pre>cmc -u -v scm2html.cmp</pre>
		</li>
		<li>Compile scm2html.cmp project using release config:
		<pre>cmc -u -v -c=release scm2html.cmp</pre>
		</li>
		<li>Change to <strong>C:\work\cmajorm\cmajor\projects\tools\spring</strong> directory.</li>
		<li>Compile spring.cmp project using debug config:
		<pre>cmc -u -v spring.cmp</pre>
		</li>
		<li>Compile spring.cmp project using release config:
		<pre>cmc -u -v -c=release spring.cmp</pre>
		</li>
		<li>Change to <strong>C:\work\cmajorm\cmajor\projects\tools\supd</strong> directory.</li>
		<li>Compile supd.cmp project using debug config:
		<pre>cmc -u -v supd.cmp</pre>
		</li>
		<li>Compile supd.cmp project using release config:
		<pre>cmc -u -v -c=release supd.cmp</pre>
		</li>
	</ol>
	
	<h2>
		14. Cmajor examples
	</h2>
	
	<p>
		Optional and not required if 9. Option 1 succeeded.
	</p>

	<ol>
		<li>Open  Windows Terminal to <strong>C:\work\cmajorm\cmajor\projects\examples</strong> directory.</li>
		<li>Compile examples.cms solution using debug config:
		<pre>
			C:\work\cmajorm\cmajor\projects\examples>cmc -u -v examples.cms
		</pre>
		</li>
		<li>Compile examples.cms solution using release config:
		<pre>
			C:\work\cmajorm\cmajor\projects\examples>cmc -u -v -c=release examples.cms
		</pre>
		</li>
	</ol>
	
	<h2>
		15. System X
	</h2>

	<p>
		Optional.
	</p>

	<ol>
		<li>Open Windows Terminal to <strong>C:\work\cmajorm\cmajor\projects\cmsx</strong> directory.</li>
		<li>Compile cmsx.cms solution using debug config:
		<pre>
			C:\work\cmajorm\cmajor\projects\cmsx> cmc -u -v cmsx.cms
		</pre>
		</li>
		<li>Compile cmsx.cms solution using release config:
		<pre>
			C:\work\cmajorm\cmajor\projects\cmsx> cmc -u -v -c=release cmsx.cms
		</pre>
		</li>
	</ol>
	
	<h2>
		16. Installation
	</h2>
	
	<ol>
		<li>Open Windows Terminal to <strong>C:\work\cmajorm\cmajor\bat</strong> directory.</li>
		<li>Run <strong>inst.bat</strong>. 
		Changed files are copied to <strong>C:\work\cmajorm\cmajor\bin</strong> and <strong>C:\work\cmajorm\cmajor\lib</strong> directories.</li>
	</ol>
</body>
