using System;
using System.Threading;

int main(int argc, const char** argv)
{
    try
    {
        string command;
        command.Append("testprog");
        for (int i = 1; i < argc; ++i)
        {
            command.Append(' ').Append(argv[i]);
        }
        string errors;
        Process process(command, 
			cast<Process.Redirections>(Process.Redirections.processStdIn | Process.Redirections.processStdOut | Process.Redirections.processStdErr));
        while (!process.Eof(Process.StdHandle.stdOut))
        {
            string line = process.ReadLine(Process.StdHandle.stdOut);
            if (!line.IsEmpty())
            {
                Console.WriteLine(line);
            }
        }
        errors = process.ReadToEnd(Process.StdHandle.stdErr);
        process.WaitForExit();
        int exitCode = process.ExitCode();
        if (exitCode != 0)
        {
            throw Exception("testprog returned exit code " + ToString(exitCode) + ": " + errors);
        }
        else
        {
            Console.WriteLine("testprog returned exit code 0");
        }
    }
    catch (const Exception& ex)
    {
        Console.Error() << ex.Message() << endl();
        return 1;
    }
    return 0;
}
