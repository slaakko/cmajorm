// =================================
// Copyright (c) 2021 Seppo Laakko
// Distributed under the MIT license
// =================================

using System;
using System.Collections;
using System.Threading;
using System.Net.Sockets;
using System.Json;
using System.Text;
using System.IO;
using Cm.Service;

namespace Cm.Service.Build
{
    public const int defaultPort = 54325;
    public const int defaultKeepAliveServerPort = 54329;
    public const int defaultKeepAliveIntervalSeconds = 60;

    public class delegate void ProgressNotificationFunction();
    public class delegate void BuildServerStartNotificationFunction();
    public class delegate void BuildServerStopNotificationFunction();

    public class BuildServiceArgs
    {
        public BuildServiceArgs() :
            port(defaultPort), keepAliveServerPort(defaultKeepAliveServerPort), log(false), wait(false),
            serverStartWaitSeconds(1), serverStopWaitSeconds(10), saveRequestOnly(false), debugServer(false)
        {
        }
        public nothrow BuildServiceArgs& ProgramName(const string& programName_)
        {
            programName = programName_;
            return *this;
        }
        public nothrow BuildServiceArgs& Pid(int pid_)
        {
            pid = pid_;
            return *this;
        }
        public nothrow BuildServiceArgs& Port(int port_)
        {
            port = port_;
            return *this;
        }
        public nothrow BuildServiceArgs& KeepAliveServerPort(int keepAliveServerPort_)
        {
            keepAliveServerPort = keepAliveServerPort_;
            return *this;
        }
        public nothrow BuildServiceArgs& Log(bool log_)
        {
            log = log_;
            return *this;
        }
        public nothrow BuildServiceArgs& Wait(bool wait_)
        {
            wait = wait_;
            return *this;
        }
        public nothrow BuildServiceArgs& ServerStartWaitSeconds(int serverStartWaitSeconds_)
        {
            serverStartWaitSeconds = serverStartWaitSeconds_;
            return *this;
        }
        public nothrow BuildServiceArgs& ServerStopWaitSeconds(int serverStopWaitSeconds_)
        {
            serverStopWaitSeconds = serverStopWaitSeconds_;
            return *this;
        }
        public nothrow BuildServiceArgs& SaveRequestOnly(bool saveRequestOnly_)
        {
            saveRequestOnly = saveRequestOnly_;
            return *this;
        }
        public nothrow BuildServiceArgs& TraceServer(bool traceServer_)
        {
            traceServer = traceServer_;
            return *this;
        }
        public nothrow BuildServiceArgs& DebugServer(bool debugServer_)
        {
            debugServer = debugServer_;
            return *this;
        }
        public string programName;
        public int pid;
        public int port;
        public int keepAliveServerPort;
        public bool log;
        public bool wait;
        public bool saveRequestOnly;
        public int serverStartWaitSeconds;
        public int serverStopWaitSeconds;
        public bool traceServer;
        public bool debugServer;
    }

    public class KeepAliveServerGuard
    {
        public nothrow KeepAliveServerGuard(bool& keepAliveServerRunning_) : keepAliveServerRunning(keepAliveServerRunning_)
        {
            keepAliveServerRunning = true;
        }
        public ~KeepAliveServerGuard()
        {
            keepAliveServerRunning = false;
        }
        private bool& keepAliveServerRunning;
    }

    public class BuildService : ServiceBase
    {
        public nothrow BuildService(BuildServiceArgs& args_) :
            base(), args(args_), notifyProgress(), terminating(false), stopKeepAlives(false), keepAliveServerRunning(false)
        {
        }
        private string MakeServerStartCommand()
        {
            string serverStartCommand = "cmbs";
            if (args.traceServer)
            {
                serverStartCommand = "cmbst";
            }
            else if (args.debugServer)
            {
                serverStartCommand = "cmbsd";
            }
            port = Cm.Service.PortMap.GetFreePortNumber(args.programName, args.pid, portMapServicePortNumber);
            bool gotNoPort = false;
            if (port == -1)
            {
                port = args.port;
                LogMessage("BuildService: got no port from port map server, resorting to default port " + ToString(port));
                gotNoPort = true;
            }
            serverStartCommand.Append(" --port=" + ToString(port));
            if (!gotNoPort)
            {
                keepAliveServerPort = Cm.Service.PortMap.GetFreePortNumber(args.programName, args.pid, portMapServicePortNumber);
            }
            serverStartCommand.Append(" --keepAliveServerPort=" + ToString(keepAliveServerPort));
            if (keepAliveServerPort == -1)
            {
                keepAliveServerPort = args.keepAliveServerPort;
                LogMessage("BuildService: got no port from port map server, resorting to default keep alive server port " + ToString(keepAliveServerPort));
            }
            if (portMapServicePortNumber != -1)
            {
                serverStartCommand.Append(" --portMapServicePort=" + ToString(portMapServicePortNumber));
            }
            if (args.log)
            {
                serverStartCommand.Append(" --log");
            }
            if (args.wait)
            {
                serverStartCommand.Append(" --wait");
            }
            return serverStartCommand;
        }
        public nothrow void SetProgressNotificationFunction(const ProgressNotificationFunction& notifyProgress_)
        {
            notifyProgress = notifyProgress_;
        }
        public nothrow void SetBuildServerStartNotificationFunction(const BuildServerStartNotificationFunction& notifyBuildServerStart_)
        {
            notifyBuildServerStart = notifyBuildServerStart_;
        }
        public nothrow void SetBuildServerStopNotificationFunction(const BuildServerStopNotificationFunction& notifyBuildServerStop_)
        {
            notifyBuildServerStop = notifyBuildServerStop_;
        }
        public nothrow bool ServerRunning() const
        {
            if (buildServer.IsNull()) return false;
            return buildServer->Running();
        }
        public bool StartServer()
        {
            try
            {
                if (ServerRunning())
                {
                    StopServer(true);
                }
                string serverStartCommand = MakeServerStartCommand();
                LogMessage("BuildService: Starting Build Server (port=" + ToString(port) + ", keep alive server port=" + ToString(keepAliveServerPort) + ")...");
                buildServer.Reset(
                    new Process(serverStartCommand,
                    cast<Process.Redirections>(Process.Redirections.processStdIn | Process.Redirections.processStdOut | Process.Redirections.processStdErr)));
                string line = buildServer->ReadLine(Process.StdHandle.stdOut);
                if (line == "build-server-error")
                {
                    line = buildServer->ReadLine(Process.StdHandle.stdOut);
                    throw Exception("BuildServer failed: " + line);
                }
                LogMessage(line);
                Sleep(Duration.FromSeconds(args.serverStartWaitSeconds));
                if (!keepAliveServerRunning)
                {
                    keepAliveThread = Thread.StartMethod(KeepAliveServer);
                }
                LogMessage("BuildService: Build Server started.");
                notifyBuildServerStart();
            }
            catch (const Exception& ex)
            {
                LogException(ex);
                LogMessage("BuildService: " + ex.Message());
                return false;
            }
            return true;
        }
        public void StopServer(bool log)
        {
            try
            {
                if (!ServerRunning()) return;
                if (keepAliveServerRunning)
                {
                    stopKeepAlives = true;
                    stopKeepAlivesVar.NotifyOne();
                    keepAliveThread.Join();
                }
                if (log)
                {
                    LogMessage("BuildService: Stopping Build Server...");
                }
                SendReceiveStopRequest();
                bool serverStopped = false;
                for (int i = 0; i < args.serverStopWaitSeconds; ++i)
                {
                    if (buildServer->Running())
                    {
                        Sleep(Duration.FromSeconds(1));
                    }
                    else
                    {
                        serverStopped = true;
                        break;
                    }
                }
                if (!serverStopped)
                {
                    if (log)
                    {
                        LogMessage("BuildService: Build Server not stopped after " + ToString(args.serverStopWaitSeconds) + " seconds, terminating server process...");
                    }
                    buildServer->Terminate();
                }
                int exitCode = buildServer->ExitCode();
                string exitCodeStr;
                if (exitCode != 0)
                {
                    exitCodeStr.Append(" Exit code=" + ToString(exitCode));
                }
                if (log)
                {
                    LogMessage("BuildService: Build Server stopped." + exitCodeStr);
                }
            }
            catch (const Exception& ex)
            {
                LogException(ex);
                if (log)
                {
                    LogMessage("BuildService: StopServer: " + ex.Message());
                }
            }
        }
        public void TerminateServer(bool logTerminate)
        {
            try
            {
                if (!ServerRunning()) return;
                terminating = true;
                if (keepAliveServerRunning)
                {
                    stopKeepAlives = true;
                    stopKeepAlivesVar.NotifyOne();
                    keepAliveThread.Join();
                }
                buildServer->Terminate();
                terminatingVar.NotifyOne();
                if (logTerminate)
                {
                    LogMessage("BuildService: Build Server stopped.");
                }
                notifyBuildServerStop();
            }
            catch (const Exception& ex)
            {
                LogException(ex);
                if (logTerminate && log)
                {
                    LogMessage("BuildService: TerminateServer: " + ex.Message());
                }
            }
        }
        public void Quit()
        {
            TerminateServer(false);
            if (keepAliveServerRunning)
            {
                stopKeepAlives = true;
                stopKeepAlivesVar.NotifyOne();
                keepAliveThread.Join();
            }
        }
        private nothrow bool StopKeepAlives(void* arg)
        {
            return stopKeepAlives;
        }
        public void KeepAliveServer()
        {
            KeepAliveServerGuard keepAliveServerGuard(keepAliveServerRunning);
            try
            {
                RtSetThreadId('K');
                stopKeepAlives = false;
                while (!stopKeepAlives)
                {
                    if (stopKeepAlivesVar.WaitFor(keepAliveMutex, StopKeepAlives, null, Duration.FromSeconds(defaultKeepAliveIntervalSeconds)))
                    {
                        return;
                    }
                    else
                    {
                        SendReceiveKeepAliveRequest();
                    }
                }
            }
            catch (const Exception& ex)
            {
                LogException(ex);
            }
        }
        private void SendReceiveStopRequest()
        {
            TcpSocket socket("localhost", ToString(port));
            StopRequest stopRequest;
            UniquePtr<JsonValue> requestJsonValue = stopRequest.ToJson();
            string requestStr = requestJsonValue->ToString();
            Write(socket, requestStr);
            string replyStr = ReadStr(socket);
            UniquePtr<JsonValue> replyJsonValue = ParseJson(replyStr);
            string messageKind = GetMessageKind(replyJsonValue.Get());
            if (messageKind == "stopReply")
            {
                StopReply reply(replyJsonValue.Get());
            }
            else
            {
                throw Exception("stopReply expected, unknown reply message kind '" + messageKind + "' received");
            }
        }
        private void SendReceiveKeepAliveRequest()
        {
            TcpSocket socket("localhost", ToString(keepAliveServerPort));
            KeepAliveRequest keepAliveRequest;
            UniquePtr<JsonValue> requestJsonValue = keepAliveRequest.ToJson();
            string requestStr = requestJsonValue->ToString();
            Write(socket, requestStr);
            string replyStr = ReadStr(socket);
            UniquePtr<JsonValue> replyJsonValue = ParseJson(replyStr);
            string messageKind = GetMessageKind(replyJsonValue.Get());
            if (messageKind == "keepAliveReply")
            {
                KeepAliveReply reply(replyJsonValue.Get());
            }
            else
            {
                throw Exception("keepAliveReply expected, unknown reply message kind '" + messageKind + "' received");
            }
        }
        public List<CompileError> ProcessBuildRequest(const BuildRequest& request)
        {
            try
            {
                terminating = false;
                if (!ServerRunning())
                {
                    if (!StartServer())
                    {
                        return List<CompileError>();
                    }
                }
                UniquePtr<JsonValue> requestJsonValue = request.ToJson();
                StreamWriter requestWriter(File.CreateText(Path.Combine(CmCodeLogDir(), "build-request.json")));
                CodeFormatter requestFormatter(requestWriter);
                requestJsonValue->Write(requestFormatter);
                if (saveRequestOnly) return List<CompileError>();
                TcpSocket socket("localhost", ToString(port));
                string requestStr = requestJsonValue->ToString();
                Write(socket, requestStr);
                string replyStr = ReadStr(socket);
                UniquePtr<JsonValue> replyJsonValue = ParseJson(replyStr);
                string messageKind = GetMessageKind(replyJsonValue.Get());
                while (messageKind == "logMessageRequest" || messageKind == "progressMessage")
                {
                    if (messageKind == "logMessageRequest")
                    {
                        LogMessageRequest logMessageRequest(replyJsonValue.Get());
                        string message = logMessageRequest.message;
                        LogMessage(message);
                        LogMessageReply logMessageReply;
                        logMessageReply.ok = true;
                        UniquePtr<JsonValue> logMessageReplyJsonValue = logMessageReply.ToJson();
                        string logMessageReplyStr = logMessageReplyJsonValue->ToString();
                        Write(socket, logMessageReplyStr);
                    }
                    else if (messageKind == "progressMessage")
                    {
                        ProgressMessage progressMessage(replyJsonValue.Get());
                        notifyProgress();
                    }
                    replyStr = ReadStr(socket);
                    replyJsonValue = ParseJson(replyStr);
                    messageKind = GetMessageKind(replyJsonValue.Get());
                }
                if (messageKind == "buildReply")
                {
                    StreamWriter replyWriter(File.CreateText(Path.Combine(CmCodeLogDir(), "build-reply.json")));
                    CodeFormatter replyFormatter(replyWriter);
                    replyJsonValue->Write(replyFormatter);
                    BuildReply buildReply(replyJsonValue.Get());
                    return ProcessBuildReply(buildReply);
                }
                else if (messageKind == "genericErrorReply")
                {
                    GenericErrorReply genericErrorReply(replyJsonValue.Get());
                    LogMessage("BuildService: ProcessBuildRequest: generic error reply received: " + genericErrorReply.error);
                }
                else
                {
                    throw Exception("unknown reply message kind received");
                }
            }
            catch (const Exception& ex)
            {
                if (!terminating)
                {
                    LogException(ex);
                    LogMessage("BuildService: ProcessBuildRequest: " + ex.Message());
                }
            }
            return List<CompileError>();
        }
        private List<CompileError> ProcessBuildReply(const BuildReply& buildReply)
        {
            if (buildReply.success)
            {
                LogMessage("BuildService: build successful, time=" + buildReply.time);
            }
            else
            {
                LogMessage("BuildService: build unsuccessful");
            }
            if (!buildReply.requestValid)
            {
                throw Exception("server claims build request not valid: " + buildReply.requestErrorMessage);
            }
            if (!buildReply.logException.IsEmpty())
            {
                throw Exception("server log exception: " + buildReply.logException);
            }
            return Rvalue(buildReply.errors);
        }
        public void ProcessCacheModuleRequest(const CacheModuleRequest& cacheModuleRequest)
        {
            try
            {
                if (!ServerRunning())
                {
                    if (!StartServer())
                    {
                        return;
                    }
                }
                UniquePtr<JsonValue> requestJsonValue = cacheModuleRequest.ToJson();
                TcpSocket socket("localhost", ToString(port));
                string requestStr = requestJsonValue->ToString();
                Write(socket, requestStr);
                string replyStr = ReadStr(socket);
                UniquePtr<JsonValue> replyJsonValue = ParseJson(replyStr);
                string messageKind = GetMessageKind(replyJsonValue.Get());
            }
            catch (const Exception& ex)
            {
                LogException(ex);
                LogMessage("BuildService: ProcessCacheModuleRequest: " + ex.Message());
            }
        }
        public GetDefinitionReply ProcessGetDefinitionRequest(const GetDefinitionRequest& request)
        {
            GetDefinitionReply reply;
            try
            {
                if (!ServerRunning())
                {
                    if (!StartServer())
                    {
                        reply.ok = false;
                        reply.error = "could not start server";
                        return reply;
                    }
                }
                UniquePtr<JsonValue> requestJsonValue = request.ToJson();
                TcpSocket socket("localhost", ToString(port));
                string requestStr = requestJsonValue->ToString();
                Write(socket, requestStr);
                string replyStr = ReadStr(socket);
                UniquePtr<JsonValue> replyJsonValue = ParseJson(replyStr);
                string messageKind = GetMessageKind(replyJsonValue.Get());
                if (messageKind == "getDefinitionReply")
                {
                    reply = GetDefinitionReply(replyJsonValue.Get());
                }
                else
                {
                    throw Exception("'getDefinitionReply' expected");
                }
            }
            catch (const Exception& ex)
            {
                LogException(ex);
                LogMessage("BuildService: ProcessGetDefinitionRequest: " + ex.Message());
                reply.ok = false;
                reply.error = ex.Message();
            }
            return reply;
        }
        private string GetMessageKind(JsonValue* jsonValue)
        {
            if (jsonValue is JsonObject*)
            {
                JsonObject* jsonObject = cast<JsonObject*>(jsonValue);
                JsonValue* messageKindValue = jsonObject->GetField(u"messageKind");
                if (messageKindValue is JsonString*)
                {
                    JsonString* messageKindStr = cast<JsonString*>(messageKindValue);
                    string messageKind = ToUtf8(messageKindStr->Value());
                    return messageKind;
                }
            }
            return string();
        }
        private void Progress()
        {
            notifyProgress();
        }
        private BuildServiceArgs args;
        private int port;
        private int keepAliveServerPort;
        private int portMapServicePortNumber;
        private bool log;
        private bool saveRequestOnly;
        private bool terminating;
        private bool stopKeepAlives;
        private bool keepAliveServerRunning;
        private ConditionVariable terminatingVar;
        private ConditionVariable stopKeepAlivesVar;
        private ProgressNotificationFunction notifyProgress;
        private BuildServerStartNotificationFunction notifyBuildServerStart;
        private BuildServerStopNotificationFunction notifyBuildServerStop;
        private string serverStartCommand;
        private UniquePtr<Process> buildServer;
        private Thread keepAliveThread;
        private RecursiveMutex keepAliveMutex;
    }
}
