// =================================
// Copyright (c) 2020 Seppo Laakko
// Distributed under the MIT license
// =================================

using System;
using System.Windows;

namespace spring
{
    public class Canvas : Control
    {
        public Canvas(const Color& backgroundColor, const Point& location, const Size& size, Dock dock, Anchors anchors) :
            base("spring.canvas", DoubleClickWindowClassStyle(), DefaultChildWindowStyle(), DefaultExtendedWindowStyle(),
            backgroundColor, "canvas", location, size, dock, anchors), diagram(new Diagram())
        {
        }
        public Canvas() : this(Color.White(), Point(0, 0), Size(0, 0), Dock.fill, Anchors.none) // todo
        {
        }
        protected override void SetCursor()
        {
            SetCursor(*Tools.Current()->GetCursor());
        }
        protected override void OnPaint(PaintEventArgs& args)
        {
            if (diagram->Invalidated())
            {
                diagram->ResetInvalidated();
            }
            Unit prevUnit = args.graphics.GetPageUnitChecked();
            TextRenderingHint prevTextRenderingHint = args.graphics.GetTextRenderingHint();
            args.graphics.SetTextRenderingHintChecked(TextRenderingHint.clearTypeGridFit);
            args.graphics.SetPageUnitChecked(Unit.millimeter);
            args.graphics.ClearChecked(BackgroundColor());
            diagram->Draw(args.graphics);
            args.graphics.SetTextRenderingHintChecked(prevTextRenderingHint);
            args.graphics.SetPageUnitChecked(prevUnit);
        }
        protected override void OnMouseDown(MouseEventArgs& args)
        {
            base->OnMouseDown(args);
            PointF location = ConvertLocation(args.location);
            MouseButtons buttons = args.buttons;
            DiagramElement* element = null;
            int index = diagram->GetIndexOfElementAt(location);
            if (index != -1)
            {
                element = diagram->GetElementByIndex(index);
            }
            Tools.Current()->MouseDown(*diagram, location, buttons, index, element);
            if (diagram->Invalidated())
            {
                Invalidate();
            }
        }
        protected override void OnMouseDoubleClick(MouseEventArgs& args)
        {
            base->OnMouseDoubleClick(args);
            PointF location = ConvertLocation(args.location);
            int index = diagram->GetIndexOfElementAt(location);
            DiagramElement* element = null;
            if (index != -1)
            {
                element = diagram->GetElementByIndex(index);
            }
            Tools.Current()->MouseDoubleClick(*diagram, location, index, element);
            if (diagram->Invalidated())
            {
                Invalidate();
            }
        }
        private nothrow PointF ConvertLocation(const Point& location)
        {
            float x = ScreenMetrics.Get().HorizontalPixelsToMM(location.x);
            float y = ScreenMetrics.Get().VerticalPixelsToMM(location.y);
            return PointF(x, y);
        }
        private UniquePtr<Diagram> diagram;
        private PointF viewOrigin;
    }
}
