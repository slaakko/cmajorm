// =================================
// Copyright (c) 2020 Seppo Laakko
// Distributed under the MIT license
// =================================

using System;
using System.IO;
using System.Json;
using System.Text;
using System.Windows;

namespace cmcode
{
    [json]
    public class JsonPoint
    {
        public JsonPoint(int x_, int y_) : x(x_), y(y_)
        {
        }
        public JsonPoint(const System.Windows.Point& pt)
        {
            x = pt.x;
            y = pt.y;
        }
        public System.Windows.Point ToPoint() const
        {
            System.Windows.Point pt(x, y);
            return pt;
        }
        public int x;
        public int y;
    }

    [json]
    public class JsonSize
    {
        public JsonSize(int w_, int h_) : w(w_), h(h_)
        {
        }
        public JsonSize(const System.Windows.Size& sz)
        {
            w = sz.w;
            h = sz.h;
        }
        public System.Windows.Size ToSize() const
        {
            System.Windows.Size sz(w, h);
            return sz;
        }
        public int w;
        public int h;
    }

    [json]
    public class MainConfig
    {
        public enum JsonWindowState : sbyte
        {
            normal, maximized
        }
        public nothrow MainConfig() : mainWindowWindowState(JsonWindowState.normal), verticalSplitterDistance(0), horizontalSplitterDistance(0)
        {
        }
        public System.Windows.WindowState GetMainWindowWindowState()
        {
            if (mainWindowWindowState == JsonWindowState.normal)
            {
                return System.Windows.WindowState.normal;
            }
            else if (mainWindowWindowState == JsonWindowState.maximized)
            {
                return System.Windows.WindowState.maximized;
            }
            else
            {
                return System.Windows.WindowState.normal;
            }
        }
        public void SetMainWindowWindowState(System.Windows.WindowState mainWindowWindowState_)
        {
            if (mainWindowWindowState_ == System.Windows.WindowState.maximized)
            {
                mainWindowWindowState = JsonWindowState.maximized;
            }
            else
            {
                mainWindowWindowState = JsonWindowState.normal;
            }
        }
        public System.Windows.Point GetMainWindowLocation() const
        {
            return mainWindowLocation.ToPoint();
        }
        public void SetMainWindowLocation(const System.Windows.Point& location)
        {
            mainWindowLocation = JsonPoint(location);
        }
        public System.Windows.Size GetMainWindowSize() const
        {
            return mainWindowSize.ToSize();
        }
        public void SetMainWindowSize(const System.Windows.Size& size)
        {
            mainWindowSize = JsonSize(size);
        }
        public int GetMainWindowVerticalSplitterDistance() const
        {
            return verticalSplitterDistance;
        }
        public void SetMainWindowVerticalSplitterDistance(int verticalSplitterDistance_)
        {
            verticalSplitterDistance = verticalSplitterDistance_;
        }
        public int GetMainWindowHorizontalSplitterDistance() const
        {
            return horizontalSplitterDistance;
        }
        public void SetMainWindowHorizontalSplitterDistance(int horizontalSplitterDistance_)
        {
            horizontalSplitterDistance = horizontalSplitterDistance_;
        }
        private JsonWindowState mainWindowWindowState;
        private JsonPoint mainWindowLocation;
        private JsonSize mainWindowSize;
        private int verticalSplitterDistance;
        private int horizontalSplitterDistance;
    }

    public class MainConfiguration
    {
        static MainConfiguration() : instance(new MainConfiguration())
        {
        }
        public static nothrow MainConfiguration& Instance()
        {
            return *instance;
        }
        private MainConfiguration()
        {
            string cmajorRoot;
            const char* cmajorRootEnv = RtGetEnvironmentVariable("CMAJOR_ROOT");
            if (cmajorRootEnv != null)
            {
                cmajorRoot = GetFullPath(cmajorRootEnv);
            }
            else
            {
                error = "CMAJOR_ROOT environment variable not set";
            }
            if (!cmajorRoot.IsEmpty())
            {
                jsonFilePath = Path.Combine(Path.Combine(cmajorRoot, "config"), "cmcode.config.json");
            }
        }
        public void Save(bool force)
        {
            try
            {
                if (!force)
                {
                    if (!dirty) return;
                    if (Now() - configChangedTime < Duration.FromSeconds(3))
                    {
                        return;
                    }
                }
                dirty = false;
                if (!jsonFilePath.IsEmpty())
                {
                    UniquePtr<JsonValue> mainConfigJsonValue = mainConfig.ToJson();
                    StreamWriter writer(File.CreateText(jsonFilePath));
                    CodeFormatter formatter(writer);
                    mainConfigJsonValue->Write(formatter);
                }
            }
            catch (const Exception& ex)
            {
            }
        }
        public void Load()
        {
            try
            {
                if (!error.IsEmpty())
                {
                    throw Exception(error);
                }
                if (!jsonFilePath.IsEmpty())
                {
                    if (File.Exists(jsonFilePath))
                    {
                        string content = File.ReadAllText(jsonFilePath);
                        UniquePtr<JsonValue> mainConfigJsonValue = ParseJson(content);
                        FromJson(mainConfigJsonValue.Get(), mainConfig);
                        loaded = true;
                    }
                }
            }
            catch (const Exception& ex)
            {
                MessageBox.Show("settings could not be loaded: " + ex.Message(), "Warning", null, cast<MessageBoxType>(MessageBoxType.MB_OK | MessageBoxType.MB_ICONSTOP));
            }
        }
        public nothrow bool Loaded() const
        {
            return loaded;
        }
        public System.Windows.WindowState GetMainWindowWindowState() const
        {
            return mainConfig.GetMainWindowWindowState();
        }
        public void SetMainWindowWindowState(System.Windows.WindowState mainWindowWindowState_)
        {
            if (GetMainWindowWindowState() != mainWindowWindowState_)
            {
                mainConfig.SetMainWindowWindowState(mainWindowWindowState_);
                SetChanged();
            }
        }
        public System.Windows.Point GetMainWindowLocation() const
        {
            return mainConfig.GetMainWindowLocation();
        }
        public System.Windows.Size GetMainWindowSize() const
        {
            return mainConfig.GetMainWindowSize();
        }
        public void SetMainWindowLocation(const System.Windows.Point& location)
        {
            if (GetMainWindowLocation() != location)
            {
                mainConfig.SetMainWindowLocation(location);
                SetChanged();
            }
        }
        public void SetMainWindowSize(const System.Windows.Size& size)
        {
            if (GetMainWindowSize() != size)
            {
                mainConfig.SetMainWindowSize(size);
                SetChanged();
            }
        }
        public int GetMainWindowVerticalSplitterDistance() const
        {
            return mainConfig.GetMainWindowVerticalSplitterDistance();
        }
        public void SetMainWindowVerticalSplitterDistance(int verticalSplitterDistance)
        {
            if (GetMainWindowVerticalSplitterDistance() != verticalSplitterDistance)
            {
                mainConfig.SetMainWindowVerticalSplitterDistance(verticalSplitterDistance);
                SetChanged();
            }
        }
        public int GetMainWindowHorizontalSplitterDistance() const
        {
            return mainConfig.GetMainWindowHorizontalSplitterDistance();
        }
        public void SetMainWindowHorizontalSplitterDistance(int horizontalSplitterDistance)
        {
            if (GetMainWindowHorizontalSplitterDistance() != horizontalSplitterDistance)
            {
                mainConfig.SetMainWindowHorizontalSplitterDistance(horizontalSplitterDistance);
                SetChanged();
            }
        }
        private void SetChanged()
        {
            dirty = true;
            configChangedTime = Now();
        }
        private static UniquePtr<MainConfiguration> instance;
        private string error;
        private string jsonFilePath;
        private MainConfig mainConfig;
        private TimePoint configChangedTime;
        private bool loaded;
        private bool dirty;
    }
}
