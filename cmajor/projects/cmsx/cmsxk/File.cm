using System;
using System.IO;
using cmsx.machine;

namespace cmsx.kernel
{
    public long Write(Machine& machine, Process* process, int handle, ulong bufferAddress, long count)
    {
        if (handle != stdout && handle != stderr)
        {
            return -1;
        }
        else if (count > 0)
        {
            UniquePtr<byte> buffer(cast<byte*>(RtMemAlloc(count)));
            int rv = ReadProcessMemory(machine, process, bufferAddress, buffer.Get(), cast<ulong>(count));
            if (rv != 0)
            {
                return -1;
            }
            ByteStream* stream = null;
            if (handle == stdout)
            {
                stream = Console.Out().ContainedStream().Get();
            }
            else if (handle == stderr)
            {
                stream = Console.Error().ContainedStream().Get();
            }
            else
            {
                return -1;
            }
            try
            {
                stream->Write(buffer.Get(), count);
            }
            catch (const Exception& ex)
            {
                return -1;
            }
            return count;
        }
        return 0;
    }
}
